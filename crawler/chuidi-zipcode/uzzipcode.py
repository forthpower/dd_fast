#!/usr/bin/env python3
"""
根据邮编列表查询地址信息
"""
import csv
from pathlib import Path
from datetime import datetime

# 邮编列表
post_code_list = [
"33603", "63638", "12309", "11756", "11756", "33545", "21754", "63638", "21754", "89521",
"97224", "33603", "33418", "77505", "68136", "49519", "18411", "18510", "90706", "18510",
"46255", "49221", "14221", "18411", "73099", "35750", "74878", "27203", "27317", "90706",
"91406", "34288", "89523", "73099", "37043", "74878", "37043", "80111", "60617", "79103",
"80033", "85036", "10031", "08052", "61081", "78163", "57467", "60617", "67335", "67335",
"68116", "69169", "75002", "25411", "28546", "75002", "10118", "37138", "37721", "46410",
"46410", "46410", "03264", "30058", "60632", "79938", "03264", "30101", "66614", "30004",
"60632", "97233", "85718", "98686", "85750", "85718", "85750", "55406", "85718", "80917",
"85750", "20911", "20191", "02346", "12804", "94605", "55016", "91406", "27253", "42701",
"33349", "33349", "55406", "12804", "96706", "78628", "85718", "96706", "85750", "64076",
"37064", "91017", "90014", "64076", "91406", "22032", "20124", "92057", "80504", "64076",
"89436", "30101", "91406", "76082", "02713", "94544", "02346", "94521", "07960", "91406",
"14120", "12804", "12804", "98422", "30101", "76082", "62366", "80917", "29168", "22032",
"20124", "57106", "11220", "55301", "11967", "07047", "30101", "07047", "21157", "40220",
"07047", "85306", "10118", "10031", "02721", "34287", "85202", "37072", "22603", "60617",
"85022", "48187", "92626", "85202", "38316", "08831", "55113", "33401", "43215", "92503",
"90060", "92313", "98826", "90603", "33401", "85306", "14618", "27587", "90603", "85139",
"78610", "80220", "27587", "59102", "88240", "55119", "13159", "85306", "89077", "64804",
"89052", "33161", "37857", "30328", "30028", "95826", "93230", "33401", "30316", "30316",
"35611", "33401", "30096", "33401", "18966", "31294", "31294", "18966", "55117", "60602",
"60631", "78610", "02062", "76120", "34207", "60601", "42302", "42302", "89147", "63034",
"91006", "93555", "95131", "98115", "98034", "89512", "77872", "91801", "03801", "94404",
"37857", "92374", "31907", "85203", "38060", "77040", "64109", "30301", "33064", "76248",
"33443", "76107", "19027", "33442", "33624", "28215", "77872", "44024", "30066", "44116",
"77081", "41101", "71037", "41101", "22630", "19149", "06708", "39110", "22630", "06708",
"07105", "07104", "32503", "90060", "77872", "34668", "06708", "21117", "46255", "90060",
"20015", "85251", "20019", "33499", "49855", "40311", "85298", "90060", "85036", "46255",
"85254", "49855", "85298", "85036", "85254", "49855", "92840", "01507", "01501", "85036",
"53213", "53222", "84078", "90060", "01984", "84078", "96819", "29045", "38915", "85298",
"97056", "51106", "07470", "22305", "20170", "84078", "98275", "19027", "84078", "38060",
"21921", "78108", "33349", "51106", "76107", "20149", "33017", "33131", "60656", "32824",
"97707", "77568", "19007", "02116", "08876", "02116", "49058", "84341", "80130", "02116",
"20721", "59901", "59701", "02116", "23504", "75070", "75070", "20721", "23504", "23504",
"23504", "23504", "23504", "23504", "23504", "23504", "23504", "23504", "30720", "32533",
"34946", "52317", "77845", "91042", "53048", "85266", "72113", "32824", "02472", "02472",
"07728", "08520", "95054", "07310", "76123", "85266", "76028", "97224", "70420", "78737",
"11802", "89148", "78233", "76123", "11434", "76028", "12435", "14617", "76092", "10031",
"76092", "64128", "68124", "89178", "89103", "93291", "85298", "90041", "45040", "89148",
"87507", "87508", "85251", "75216", "02116", "75216", "77868", "68701", "75216", "94618",
"94606", "80210", "43609", "90041", "45030", "76092", "07470", "11764", "20721", "68701",
"80130", "68701", "78641", "28055", "61108", "79556", "70152", "30720", "92307", "37825",
"63123", "30058", "60126", "38666", "45804", "70152", "84042", "89148", "85298", "48038",
"68701", "63123", "85298", "64151", "70152", "68701", "48038", "80129", "07030", "70152",
"91405", "48038", "64117", "85298", "63123", "77059", "60656", "28345", "19525", "93454",
"91214", "85036", "07310", "68197", "08822", "08822", "57022", "33180", "62208", "30268",
"62208", "79556", "63123", "79556", "79556", "93454", "49058", "21550", "76107", "79556",
"39042", "76179", "43609", "10118", "10031", "37211", "90060", "76179", "96706", "49519",
"37221", "14228", "46074", "43619", "44146", "46074", "44691", "44691", "44214", "90060",
"89113", "89121", "97703", "32304", "55442", "55113", "32304", "60617", "28754", "49519",
"70121", "70420", "16046", "17331", "15044", "30084", "33162", "60629", "75270", "10451",
"60636", "07645", "21617", "19608", "77868", "21617", "77868", "28214", "76048", "15601",
"16046", "50307", "15044", "35475", "16929", "50307", "33813", "55423", "49519", "78253",
"63017", "92101", "33813", "97403", "97405", "55423", "11702", "97707", "11779", "61103",
"97707", "11779", "97603", "39206", "35475", "28210", "98944", "21617", "19901", "21617",
"23608", "45040", "19901", "21617", "30301", "60607", "21607", "10025", "21617", "70507",
"21607", "28205", "39206", "53705", "68008", "53705", "68008", "20740", "20149", "44622",
"86511", "10453", "77025", "10453", "76043", "29708", "81007", "76043", "86511", "61614",
"92804", "95141", "21617", "45322", "02472", "60656", "32312", "21607", "33186", "33460",
"98033", "39206", "20149", "10118", "21617", "30301", "36532", "21617", "37772", "37774",
"01603", "91402", "32531", "46074", "94107", "94553", "91741", "77385", "47331", "35124",
"35759", "92804", "74063", "11355", "11355", "28097", "39525", "35759", "11413", "11434",
"11201", "28551", "40311", "85036", "98198", "28551", "20175", "33604", "97206", "98662",
"33460", "07960", "84115", "97132", "97128", "07960", "37405", "99224", "33197", "99577",
"33197", "80109", "43076", "92038", "47201", "78758", "60931", "07621", "64151", "60931",
"33033", "07933", "48141", "48185", "76043", "94066", "37129", "30058", "97381", "91405",
"37122", "64151", "97381", "10038", "96816", "23504", "64151", "19810", "60931", "39564",
"37013", "48221", "60931", "98027", "61107", "39564", "90008", "94533", "94534", "37122",
"84009", "91006", "28270", "68803", "99203", "45764", "01201", "53214", "53214", "07047",
"85718", "85750", "97603", "90008", "22942", "84790", "30328", "84790", "74804", "60632",
"48221", "48185", "37122", "60931", "10016", "60931", "60632", "37211", "77002", "60645",
"37211", "28443", "28443", "28443", "76107", "38462", "84790", "72756", "47201", "98004",
"30165", "70130", "35960", "71403", "98004", "77087", "28443", "72756", "07055", "91741",
"75060", "30165", "35960", "90813", "61523", "90060", "90060", "91741", "34203", "02330",
"60645", "79705", "99203", "60607", "77407", "61523", "90813", "02330", "70814", "27587",
"27587", "23692", "46123", "90060", "98007", "90813", "78108", "92648", "02459", "10033",
"94568", "10463", "37083", "93550", "95628", "64501", "77382", "49507", "11706", "11752",
"46845", "32908", "46845", "11706", "11752", "77407", "48413", "77407", "32908", "53048",
"66103", "46845", "48413", "77407", "98083", "46845", "77840", "11706", "11752", "31144",
"94044", "30101", "77407", "98083", "90017", "94061", "94025", "59802", "20817", "99577",
"77447", "61462", "78758", "89045", "20817", "83687", "92646", "94566", "20817", "94566",
"98121", "20817", "37211", "37014", "03038", "92648", "85036", "34741", "98121", "60639",
"84044", "92154", "37211", "37014", "94803", "98360", "46123", "98360", "74063", "33579",
"60440", "13219", "21502", "92782", "21502", "78260", "78258", "75240", "75070", "85036",
"76244", "46224", "47305", "46224", "47305", "48083", "46224", "55414", "47305", "46970",
"55414", "46224", "55414", "48083", "43220", "20191", "43220", "77388", "43220", "76513",
"76513", "76513", "10031", "76513", "32548", "32548", "98121", "32548", "32548", "32548",
"33178", "32548", "32548", "27504", "32548", "33837", "66103", "32548", "33178", "32548",
"92591", "28443", "77713", "66103", "76513", "10004", "94550", "92591", "60602", "63303",
"71269", "33618", "85641", "60543", "76107", "76107", "23237", "48105", "90020", "75270",
"97453", "10031", "48186", "10031", "35292", "19403", "45140", "60108", "60108", "77494",
"01568", "50701", "27513", "27514", "50701", "50701", "50701", "44326", "44319", "10031",
"49341", "10031", "60602", "50701", "99203", "96782", "54568", "50701", "91362", "78745",
"49058", "53704", "96701", "60638", "28210", "28205", "99352", "30188", "37361", "37087",
"90503", "90804", "95141", "95691", "95691", "37148", "83702", "98052", "28262", "78572",
"96813", "96813", "84115", "84115", "89052", "78758", "89052", "99352", "75062", "34731",
"91380", "91350", "04240", "57108", "57108", "85254", "18042", "23504", "28269", "57108",
"37090", "98002", "57108", "75202", "78109", "40517", "40517", "43224", "40503", "43209",
"40403", "98826", "32073", "75062", "79705", "15212", "79705", "18969", "37135", "37014",
"37122", "37122", "10003", "37122", "99701", "10003", "06611", "10003", "78233", "75070",
"99203", "75062", "92705", "75062", "60657", "10003", "63033", "11233", "11358", "98012",
"92840", "20906", "85204", "94087", "46992", "29526", "98002", "48186", "29728", "15212",
"85036", "15012", "90813", "23432", "17837", "46530", "97602", "87144", "87124", "49534",
"94568", "97124", "85251", "85251", "80238", "80212", "80211", "77316", "77316", "77316",
"49534", "43232", "92821", "91765", "10118", "95141", "15212", "60606", "60606", "48074",
"55414", "98445", "55301", "94204", "08873", "08904", "78109", "94204", "93648", "78109",
"94204", "93648", "94204", "93648", "96761", "20902"
]

def load_zipcode_data(csv_path: str = "us_zipcodes.csv"):
    """加载邮编数据到字典，以邮编为键"""
    zipcode_dict = {}
    csv_file = Path(csv_path)
    
    if not csv_file.exists():
        print(f"错误: 找不到数据文件 {csv_file}")
        return zipcode_dict
    
    try:
        with open(csv_file, "r", encoding="utf-8-sig") as f:
            reader = csv.DictReader(f)
            for row in reader:
                zip_code = row["zip"].strip()
                if zip_code:
                    # 如果同一个邮编有多条记录，保存为列表
                    if zip_code not in zipcode_dict:
                        zipcode_dict[zip_code] = []
                    zipcode_dict[zip_code].append(row)
        print(f"已加载 {len(zipcode_dict)} 个唯一邮编的数据")
    except Exception as e:
        print(f"加载数据失败: {e}")
    
    return zipcode_dict


def format_address(row):
    """格式化地址信息"""
    return f"{row['city']}, {row['state_abbr']} {row['zip']} ({row['county']})"


def query_postcodes():
    """查询邮编列表对应的地址"""
    # 加载数据
    zipcode_dict = load_zipcode_data()
    
    if not zipcode_dict:
        return
    
    # 去重并排序
    unique_postcodes = sorted(set(post_code_list))
    print(f"\n需要查询的邮编数量: {len(unique_postcodes)} (去重后)")
    print("开始查询...\n")
    
    results = []
    found_count = 0
    not_found = []
    
    for zip_code in unique_postcodes:
        zip_str = zip_code.zfill(5)  # 确保邮编是5位数字格式
        if zip_str in zipcode_dict:
            found_count += 1
            addresses = zipcode_dict[zip_str]
            # 如果有多条记录，取第一条
            row = addresses[0]
            address = format_address(row)
            results.append({
                "zip": zip_str,
                "city": row["city"],
                "state": row["state"],
                "state_abbr": row["state_abbr"],
                "county": row["county"],
                "lat": row["lat"],
                "lng": row["lng"],
                "address": address
            })
            print(f"✓ {zip_str}: {address}")
        else:
            not_found.append(zip_str)
            print(f"✗ {zip_str}: 未找到")
    
    # 保存结果到 CSV
    output_file = f"postcode_addresses_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
    with open(output_file, "w", newline="", encoding="utf-8") as f:
        writer = csv.writer(f)
        writer.writerow(["邮编", "城市", "州", "州缩写", "县", "纬度", "经度", "完整地址"])
        for r in results:
            writer.writerow([
                r["zip"], r["city"], r["state"], r["state_abbr"],
                r["county"], r["lat"], r["lng"], r["address"]
            ])
    
    # 保存未找到的邮编
    if not_found:
        not_found_file = f"postcode_not_found_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
        with open(not_found_file, "w", encoding="utf-8") as f:
            f.write("\n".join(not_found))
        print(f"\n未找到的邮编已保存到: {not_found_file}")
    
    print(f"\n查询完成!")
    print(f"找到: {found_count} 个")
    print(f"未找到: {len(not_found)} 个")
    print(f"结果已保存到: {output_file}")


if __name__ == "__main__":
    query_postcodes()
